name: Sync Beijing + Shanghai

on:
  schedule:
    - cron: '0 */2 * * *'  # 每 2 小时
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 同步北京原作者
      - name: Sync Beijing (BRTV)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote add beijing https://github.com/mytv-android/BRTV-Live-M3U8.git || true
          git fetch beijing main
          git checkout main
          git merge beijing/main --allow-unrelated-histories -m "Merge Beijing source" || echo "Beijing no changes"
          cp beijing/playlist.m3u playlist_beijing.m3u 2>/dev/null || echo "Beijing M3U not found"
          git add playlist_beijing.m3u
          git commit -m "Update Beijing M3U" || echo "No Beijing changes"

      # 同步上海官方源（从 kaige-cai/live 拉上海频道）
      - name: Sync Shanghai (SHTV)
        run: |
          curl -s https://raw.githubusercontent.com/kaige-cai/live/main/tv.m3u8 -o shanghai_raw.m3u8
          grep -i -E "(东方卫视|SHTV|上海)" shanghai_raw.m3u8 > playlist_shanghai.m3u || echo "No Shanghai channels"
          git add playlist_shanghai.m3u
          git commit -m "Update Shanghai M3U" || echo "No Shanghai changes"

      # 合并生成 all.m3u
      - name: Generate Combined M3U
        run: |
          echo "#EXTM3U" > playlist_all.m3u
          echo "# 北京 + 上海全频道（自动同步）" >> playlist_all.m3u
          cat playlist_beijing.m3u playlist_shanghai.m3u >> playlist_all.m3u 2>/dev/null || echo "No sources"
          echo "# 更新于 $(date '+%Y-%m-%d %H:%M')" >> playlist_all.m3u
          git add playlist_all.m3u
          git commit -m "Generate combined M3U" || echo "No changes"

      # 推送到你的仓库
      - name: Push Updates
        run: |
          git push origin main
