name: Sync Beijing + Shanghai (Unicom/Telecom Compatible)

on:
  schedule:
    - cron: '0 */2 * * *'  # 每 2 小时
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 同步北京原作者
      - name: Sync Beijing (BRTV)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote add beijing https://github.com/mytv-android/BRTV-Live-M3U8.git || true
          git fetch beijing main
          git checkout main
          git merge beijing/main --allow-unrelated-histories -m "Merge Beijing source" || echo "Beijing no changes"
          # 复制原仓库的 iptv.m3u 为 playlist_beijing.m3u
          if [ -f "iptv.m3u" ]; then
            cp iptv.m3u playlist_beijing.m3u
            git add playlist_beijing.m3u
            git commit -m "Update Beijing M3U" || echo "No Beijing changes"
          else
            echo "Beijing iptv.m3u not found"
          fi

      # 同步上海（主源 hujingguang 实时 + 备用 suxuang + 联通手动填充）
      - name: Sync Shanghai (SHTV)
        run: |
          # 主源：hujingguang/ChinaIPTV（实时更新）
          curl -s "https://raw.githubusercontent.com/hujingguang/ChinaIPTV/main/cnTV_AutoUpdate.m3u8" -o shanghai_raw.m3u8 || echo "Failed to fetch hujingguang"
          if [ ! -s "shanghai_raw.m3u8" ]; then
            # 备用：suxuang/myIPTV
            curl -s "https://raw.githubusercontent.com/suxuang/myIPTV/main/直播源.m3u8" -o shanghai_raw.m3u8 || echo "Failed to fetch suxuang"
          fi
          if [ -s "shanghai_raw.m3u8" ]; then
            # 过滤上海频道（优化关键词）
            grep -i -E "(东方卫视|上海卫视|SHTV|上海新闻|上海纪实|上海体育|上海影视|上海少儿|上海游戏|上海动漫|上海生活|上海文广|上海演艺|第一财经|上海综合)" shanghai_raw.m3u8 > playlist_shanghai.m3u || echo "No Shanghai channels in grep"
          fi
          # 兜底：联通/电信手动填充（2025 可用，非移动）
          if [ ! -s "playlist_shanghai.m3u" ]; then
            echo "#EXTM3U" > playlist_shanghai.m3u
            echo "# 上海全频道（联通/电信源，2025-11 最新，非移动）" >> playlist_shanghai.m3u
            echo '#EXTINF:-1 tvg-logo="https://www.smg.cn/favicon.ico",东方卫视 HD (联通源)' >> playlist_shanghai.m3u
            echo 'http://121.24.98.226:8090/hls/38/index.m3u8' >> playlist_shanghai.m3u
            echo '#EXTINF:-1 tvg-logo="https://www.smg.cn/favicon.ico",SHTV新闻综合 HD' >> playlist_shanghai.m3u
            echo 'http://121.24.98.226:8090/hls/39/index.m3u8' >> playlist_shanghai.m3u
            echo '#EXTINF:-1 tvg-logo="https://www.smg.cn/favicon.ico",SHTV体育 HD' >> playlist_shanghai.m3u
            echo 'http://121.24.98.226:8090/hls/40/index.m3u8' >> playlist_shanghai.m3u
            echo '#EXTINF:-1 tvg-logo="https://www.smg.cn/favicon.ico",SHTV影视 HD' >> playlist_shanghai.m3u
            echo 'http://121.24.98.226:8090/hls/41/index.m3u8' >> playlist_shanghai.m3u
            echo '#EXTINF:-1 tvg-logo="https://www.smg.cn/favicon.ico",SHTV少儿 HD' >> playlist_shanghai.m3u
            echo 'http://121.24.98.226:8090/hls/43/index.m3u8' >> playlist_shanghai.m3u
            echo '#EXTINF:-1 tvg-logo="https://www.smg.cn/favicon.ico",SHTV第一财经 HD' >> playlist_shanghai.m3u
            echo 'http://121.24.98.226:8090/hls/42/index.m3u8' >> playlist_shanghai.m3u
            echo '#EXTINF:-1 tvg-logo="https://www.smg.cn/favicon.ico",SHTV纪实人文 HD' >> playlist_shanghai.m3u
            echo 'http://39.135.138.58:18890/PLTV/88888888/224/3221226412/index.m3u8' >> playlist_shanghai.m3u
          fi
          git add playlist_shanghai.m3u
          git commit -m "Update Shanghai M3U (Unicom/Telecom)" || echo "No Shanghai changes"

      # 合并生成 all.m3u
      - name: Generate Combined M3U
        run: |
          echo "#EXTM3U" > playlist_all.m3u
          echo "# 北京 + 上海全频道（自动同步，非移动源）" >> playlist_all.m3u
          if [ -f "playlist_beijing.m3u" ]; then cat playlist_beijing.m3u >> playlist_all.m3u; fi
          if [ -f "playlist_shanghai.m3u" ]; then cat playlist_shanghai.m3u >> playlist_all.m3u; fi
          echo "# 更新于 $(date '+%Y-%m-%d %H:%M')" >> playlist_all.m3u
          git add playlist_all.m3u
          git commit -m "Generate combined M3U" || echo "No changes"

      # 推送到你的仓库
      - name: Push Updates
        run: git push origin main

      # 清理
      - name: Cleanup
        if: always()
        run: |
          git remote remove beijing || true
          rm -f shanghai_raw.m3u8 iptv.m3u
